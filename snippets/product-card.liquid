{%- comment -%} Minimal, safe product card (no recursion, no children/block) {%- endcomment -%}
{% liquid
  assign p = product
  if p == blank and card_product != blank
    assign p = card_product
  endif

  assign onboarding = false
  if p.id == empty
    assign onboarding = true
  endif

  assign v = p.selected_or_first_available_variant
  assign img = v.featured_image
  if img == blank and p.featured_media
    assign img = p.featured_media.preview_image
  endif
%}

<product-card class="product-card" data-product-id="{{ p.id }}" id="product-card-{{ p.id }}">

<div class="product-card__content product-grid__card spacing-style border-style">
  <a
    class="product-card__link-block"
    {% unless onboarding %}href="{{ v.url }}"{% endunless %}
    aria-label="{{ p.title | escape }}"
  >
    {% if img %}
      <div class="card-gallery">
        {% assign target_w = 600 %}
        {% assign orig_w = img.width  | default: 600 %}
        {% assign orig_h = img.height | default: 600 %}
        {% if orig_w > 0 %}
          {% assign target_h = orig_h | times: target_w | divided_by: orig_w %}
        {% else %}
          {% assign target_h = 600 %}
        {% endif %}

        <img
          src="{{ img | image_url: width: target_w }}"
          srcset="
            {{ img | image_url: width: 360 }} 360w,
            {{ img | image_url: width: 600 }} 600w,
            {{ img | image_url: width: 900 }} 900w
          "
          sizes="(min-width: 750px) 33vw, 100vw"
          width="{{ target_w }}"
          height="{{ target_h }}"
          alt="{{ p.title | escape }}"
          loading="lazy"
          decoding="async"
          class="product-card__image"
        >
      </div>
    {% endif %}

    <div class="product-card__title">{{ p.title }}</div>

    <div class="product-card__price">
      {% if p.compare_at_price > p.price %}
        <span class="product-card__price--sale">{{ p.price | money }}</span>
        <s class="product-card__price--compare">{{ p.compare_at_price | money }}</s>
      {% else %}
        <span>{{ p.price | money }}</span>
      {% endif %}
    </div>
  </a>
</div>
</product-card>

{% stylesheet %}
  product-card { width: 100%; display: block; }
  .product-card__content { display: grid; gap: 8px; }
  .card-gallery img { width: 100%; height: auto; display: block; }
  .product-card__title { font-size: 0.95rem; }
  .product-card__price { font-weight: 600; }
  .product-card__link-block { display: block; color: inherit; text-decoration: none; }
  .product-card__link-block:hover .product-card__title { text-decoration: underline; }
{% endstylesheet %}
